---
title: "Malware Diary: DigMine Part2.1 - Dynamic Analysis ฉบับคนขี้เกียจ"
date: 2019-05-30T15:22:25+07:00
draft: false
categories: ["Malware Analysis : DigMine"]
featured_image: "/images/malware-diary2/1.jpg"
featured_image_caption: "เมื่ออยากรู้ว่ามัลแวร์ทำงานยังไงแต่ Malware Sandbox กลับตรวจไม่พบ ทำไงดีน้าา?"
---

![เราเปล่าเขียนจอย เพื่อนทำให้ อิอิ](images\malware-diary2\1.jpg)



หลังจากที่ Part ที่แล้วเราได้ทำการวิเคราะห์แบบ Static Analysis ไปแล้ว แต่ก็ยังไม่ได้ข้อมูลอะไรเท่าไรนอกจาก Source Code ของมัลแวร์จริง ๆ ถ้า Source Code ไม่ได้มีการ Obfuscate ไว้เมื่อถึงจุดนี้เราควรที่จะเข้าใจการทำงานของมัลแวร์บ้างแล้ว แต่ครั้งนี้ไม่ไง เพราะถึงได้ Source Code มาแต่เราก็อ่านไม่ออกอยู่ดี -___- 

คำถามต่อมา...แล้วไงต่ออ่ะ 
ขั้นตอนต่อไปที่เราจะทำเค้าเรียกว่า Dynamic Analysis แต่เคสนี้คือเราขี้เกียจไง จะให้ไปใช้ Ollydbg หรือพวก Debugger ก็ขี้เกียจ(ความจริงก็คือใช้มั่ยเปนนนน) แต่การที่เราได้ Source Code  เราสามารถเอาไปใช้ต่อได้

จำได้ไหมครับจาก Part ที่แล้ว จาก Source Code เรารู้อะไรบ้าง?
เรารู้ว่ามันมีฟังก์ชั่นที่คาดว่าเป็นฟังก์ชั่นถอดรหัส 

```AutoIt
Func gmfnzmi($gzhkalbyyq)
	$omipkddl = ""
	For $dlcqoqsup = $rgnzkvwianz To kfwjwweupfy($gzhkalbyyq)
		$swfrwp = divznduthlwg($gzhkalbyyq, $dlcqoqsup, furhpb())
		$qkkocudrwel = ejncdqtyn($usurpagyyn, $swfrwp, iewdtkkvw())
		$omipkddl &= divznduthlwg($dxbvhjewu, $qkkocudrwel, $mpbuyk)
	Next
	Return $omipkddl
EndFunc
```

คำถามคือเราจะเอา Source Code เนี้ย ไปใช้ยังไง?
ถ้าถามคำถามนี้กับคนขี้เกียจ ๆ แบบเราก็คือในเมื่อเรารู้ว่าฟังก์ชั่นนี้เป็นฟังก์ชั่นถอดรหัสเราก็แก้มัลแวร์ให้มันแสดงค่าที่ทำการถอดรหัสออกมาสิ...

```AutoIt
Func gmfnzmi($gzhkalbyyq)
	$omipkddl = ""
	For $dlcqoqsup = $rgnzkvwianz To kfwjwweupfy($gzhkalbyyq)
		$swfrwp = divznduthlwg($gzhkalbyyq, $dlcqoqsup, furhpb())
		$qkkocudrwel = ejncdqtyn($usurpagyyn, $swfrwp, iewdtkkvw())
		$omipkddl &= divznduthlwg($dxbvhjewu, $qkkocudrwel, $mpbuyk)
	Next
	ConsoleWrite($decrypt & @CRLF)
	Return $omipkddl
EndFunc
```

จำ VM ? ที่เรา Setting ไว้ใช้จาก Part ที่แล้วได้ป่ะ? 
เราก็ไปดาวน์โหลดคอมไฟล์เลอร์ของภาษา AutoIt มาลงเพื่อรันโค๊ดมัลแวร์ที่เราได้ทำการแก้ไปด้านบน

แต่! อย่าพึ่งรันเลยนะครับ ลง Google Chrome ก่อน เพราะมัลแวร์ตัวนี้มี Mechanism บางอย่างเกี่ยวกับ Google Chrome ถ้าเราอยากเข้าใจการทำงานจำเป็นต้องติดตั้งด้วย(ถามว่ารู้ได้ไง ตอนแรกเราไม่ได้ลงอ่ะ แล้วมันก็หาอะไรไม่เจอ มาเจอทีหลังว่า DigMine มันมี Mechanism บางอย่างกับ Google Chrome ด้วย)

แล้วถ้าลง Google Chrome แล้วรันเลยมั้ย?
ก็ไม่อยู่ดี เพราะถ้าอย่างนั้นเราอาจจะรู้แค่ว่าค่าที่ถูกนำว่าถอดรหัส มีอะไรบ้าง อาจพลาดรายละเอียดบางส่วน 
โดยเฉพาะในส่วนที่เป็น Network เราคิดว่าเราไม่น่าเห็น Flow การทำงานของ Network จาก Source Code หรอกถูกมะ?
ฉนั้นเราต้องใช้สิ่งที่เรียกว่า **[Wireshark](https://www.wireshark.org/)** ครับ

ถ้าจะใช้แค่ Wireshark ในการดักจับ Packet ที่รับส่งในเครื่องเรา แต่แค่นั้นผมคิดว่ายังไม่น่าจะเพียงพอนะ เพราะถ้ามันมีการแก้ไขค่าต่าง ๆ เช่น Registry ในเครื่อง Wireshark เองไม่ได้ดักจับในส่วนนี้ด้วย เราต้องใช้โปรแกรมที่เรียกว่า **[Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)**  หรือชื่อเล่นคือ ProcMon (จากลูกพี่ Microsoft เองเบย)

ซึ่งเจ้า ProcMon  เนี่ย จริง ๆ แล้วมันคล้าย ๆ กับ Wireshark แต่สิ่งที่มันดักจับเป็น Event ที่เกิดขึ้นบน Windows  
พอติดตั้งเสร็จทั้งสามตัวเนี่ยกดอย่าลืมกด Snapshot ด้วยนะครับ เผื่ออยากกลับมาทำใหม่

เปิด Wireshark กับ ProcMon ขึ้นมา จากนั้นก็กดแคปเชอเลยครับ...

![ทำไมกดแล้วไม่เห็นได้เลยอ่ะ...](images\malware-diary2\3.jpg)



 อ้าว คนละแคปหรอ เค ๆๆๆๆ
กด Capture ของทั้งสองโปรแกรม จากนั้นก็รัน AutoIt เลยจ้าม... (ผลลัพท์ที่ได้จิ้ม[ตรงนี้]([https://github.com/jusmistic/Malware-Analysis-DigMine/blob/master/Source%20Code/malware_output.txt](https://github.com/jusmistic/Malware-Analysis-DigMine/blob/master/Source Code/malware_output.txt))จ้า)
